<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <style>
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
        }
    </style>
</head>
<body>
    <div id="booksList"></div>

    <form id="addBookForm">
        <label for="title">Title: </label>
        <input id="title" type="text" name="title" placeholder="Title"> <br>
        <label for="author">Author: </label>
        <input id="author" type="text" name="author" placeholder="Author"> <br>
        <button type="submit">OK</button>
    </form>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Edit Book</h2>
            <form id="editBookForm">
                <input type="hidden" id="editBookId" name="bookId">
                <label for="editTitle">Title: </label>
                <input type="text" id="editTitle" name="title"><br>
                <label for="editAuthor">Author: </label>
                <input type="text" id="editAuthor" name="author"><br>
                <button type="submit">Update</button>
            </form>
        </div>
    </div>

    <script>
        $(document).ready(function () {  
            function renderBooks(books) {
                var booksList = $('#booksList');
                booksList.empty();
                if (books.length === 0) {
                    booksList.append('<p>No books</p>');
                } else {
                    var ul = $('<ul></ul>');
                    books.forEach(function (book) {
                        var li = $('<li data-book-id="' + book._id + '"></li>');
                        var deleteButton = $('<button class="deleteButton">Delete</button>');
                        var editButton = $('<button class="editButton">Edit</button>');
                        li.append(document.createTextNode(book.title + ' - ' + book.author));
                        li.append(deleteButton);
                        li.append(editButton);
                        ul.append(li);
                    });
                    booksList.append(ul);
                }
            }
            
            function fetchBooks() {
                $.ajax({
                    url: '/api/books',
                    type: 'GET',
                    success: function (data) {
                        renderBooks(data);
                    },
                    error: function (error) {
                        console.error('Error fetching books:', error);
                    }
                });
            }

            fetchBooks();

            $('#addBookForm').submit(function (event) {
                event.preventDefault();
                var title = $('#title').val();
                var author = $('#author').val();
                $.ajax({
                    url: '/api/books',
                    type: 'POST',
                    data: { title: title, author: author },
                    success: function () {
                        fetchBooks();
                        $('#title').val('');
                        $('#author').val('');
                    },
                    error: function (error) {
                        console.error('Error adding book:', error);
                    }
                });
            });

            $('#booksList').on('click', '.deleteButton', function () {
                var bookId = $(this).parent().data('book-id');
                $.ajax({
                    url: '/api/books/' + bookId,
                    type: 'DELETE',
                    success: function () {
                        fetchBooks();
                    },
                    error: function (error) {
                        console.error('Error deleting book:', error);
                    }
                });
            });

            $('#booksList').on('click', '.editButton', function () {
                var bookId = $(this).parent().data('book-id');
                $.ajax({
                    url: '/api/books/' + bookId,
                    type: 'GET',
                    success: function (data) {
                        $('#editBookId').val(bookId);
                        $('#editTitle').val(data.title);
                        $('#editAuthor').val(data.author);
                        $('#editModal').show();
                    },
                    error: function (error) {
                        console.error('Error fetching book details:', error);
                    }
                });
            });

            $('#editBookForm').submit(function (event) {
                event.preventDefault();
                var bookId = $('#editBookId').val();
                var title = $('#editTitle').val();
                var author = $('#editAuthor').val();
                $.ajax({
                    url: '/api/books/' + bookId,
                    type: 'PUT',
                    data: { title: title, author: author },
                    success: function () {
                        fetchBooks();
                        $('#editModal').hide();
                    },
                    error: function (error) {
                        console.error('Error updating book:', error);
                    }
                });
            });

            $(window).click(function(event) {
                var modal = $('#editModal');
                if (event.target === modal[0]) {
                    modal.hide();
                }
            });
        });
    </script>
</body>
</html>